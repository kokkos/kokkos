name: github-Linux
on: [push, pull_request]

concurrency:
  group: ${ {github.event_name }}-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{github.event_name == 'pull_request'}}

jobs:
  CI:
    continue-on-error: true
    strategy:
      matrix:
        distro: ['fedora:latest', 'fedora:rawhide', 'ubuntu:latest']
        cxx: ['g++', 'clang++']
        cmake_build_type: ['Release', 'Debug']
        cmake_cxx_flags: ['']
        backend: ['OPENMP']
        hwloc: ['ON']
        memkind: ['OFF']
        clang-tidy: ['']
        include:
          - distro: 'fedora:intel'
            cxx: 'icpc'
            cmake_build_type: 'Release'
            cmake_cxx_flags: ''
            backend: 'OPENMP'
            hwloc: 'ON'
            clang-tidy: ''
            memkind: 'OFF'
          - distro: 'fedora:intel'
            cxx: 'icpc'
            cmake_build_type: 'Debug'
            cmake_cxx_flags: ''
            backend: 'OPENMP'
            hwloc: 'ON'
            clang-tidy: ''
            memkind: 'OFF'
          - distro: 'fedora:intel'
            cxx: 'icpx'
            cmake_build_type: 'Release'
            cmake_cxx_flags: ''
            backend: 'OPENMP'
            hwloc: 'ON'
            clang-tidy: ''
            memkind: 'OFF'
          - distro: 'fedora:intel'
            cxx: 'icpx'
            cmake_build_type: 'Debug'
            cmake_cxx_flags: ''
            backend: 'OPENMP'
            hwloc: 'ON'
            clang-tidy: ''
            memkind: 'OFF'
          - distro: 'ubuntu:latest'
            cxx: 'clang++'
            cmake_build_type: 'RelWithDebInfo'
            cmake_cxx_flags: ''
            backend: 'THREADS'
            hwloc: 'OFF'
            clang-tidy: '-DCMAKE_CXX_CLANG_TIDY="clang-tidy;-warnings-as-errors=*"'
            memkind: 'OFF'
          - distro: 'ubuntu:latest'
            cxx: 'g++'
            cmake_build_type: 'RelWithDebInfo'
            cmake_cxx_flags: ''
            backend: 'THREADS'
            hwloc: 'OFF'
            clang-tidy: ''
            memkind: 'OFF'
          - distro: 'ubuntu:latest'
            cxx: 'clang++'
            cmake_build_type: 'Debug'
            cmake_cxx_flags: '-DMEMKIND_TYPE=MEMKIND_DEFAULT'
            backend: 'OPENMP'
            hwloc: 'OFF'
            clang-tidy: ''
            memkind: 'ON'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/kokkos/ci-containers/${{ matrix.distro }}
      # see https://github.com/actions/virtual-environments/issues/3812
      options: --security-opt seccomp=unconfined
    steps:
      - name: Checkout code
        uses: actions/checkout@v2.2.0
      - uses: actions/cache@v2
        with:
          path: ~/.ccache
          key: kokkos-${{ matrix.distro }}-${{ matrix.cxx }}-${{ matrix.cmake_build_type }}-${{ matrix.openmp }}-${github.ref}-${{ github.sha }}
          restore-keys: kokkos-${{ matrix.distro }}-${{ matrix.cxx }}-${{ matrix.cmake_build_type }}-${{ matrix.openmp }}-${{github.ref}}
      - name: maybe_disable_death_tests
        if: ${{ matrix.distro == 'fedora:rawhide' }}
        run: echo "GTEST_FILTER=-*DeathTest*" >> $GITHUB_ENV
      - name: maybe_use_external_gtest
        if: ${{ matrix.distro == 'ubuntu:latest' }}
        run: sudo apt-get update && sudo apt-get install -y libgtest-dev
      - name: maybe_install_memkind
        if: ${{ matrix.memkind == 'ON' }}
        run: sudo apt-get update && sudo apt-get install -y libmemkind-dev numactl
      - name: maybe_install_clang_tidy
        if: ${{ matrix.clang-tidy != '' }}
        run: sudo apt-get update && sudo apt-get install -y clang-tidy
      - name: CMake
        run: |
          cmake -B builddir \
            -DCMAKE_INSTALL_PREFIX=/usr \
            ${{ matrix.clang-tidy }} \
            -DKokkos_ARCH_NATIVE=ON \
            -DKokkos_ENABLE_HWLOC=${{ matrix.hwloc }} \
            -DKokkos_ENABLE_MEMKIND=${{ matrix.memkind }} \
            -DKokkos_ENABLE_${{ matrix.backend }}=ON \
            -DKokkos_ENABLE_TESTS=ON \
            -DKokkos_ENABLE_EXAMPLES=ON \
            -DKokkos_ENABLE_DEPRECATED_CODE_3=ON \
            -DKokkos_ENABLE_DEPRECATION_WARNINGS=OFF \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_CXX_FLAGS=${{ matrix.cmake_cxx_flags }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.cmake_build_type }}
      - name: Build
        run: |
          ccache -z
          cmake --build builddir --parallel 2
          ccache -s
      - name: Tests
        if: ${{ matrix.memkind == 'ON' }}
        working-directory: builddir
        run: numactl --membind=0 --cpunodebind=0 ctest --output-on-failure
      - name: Tests
        if: ${{ matrix.memkind == 'OFF' }}
        working-directory: builddir
        run: ctest --output-on-failure
      - name: Test DESTDIR Install
        run: DESTDIR=${PWD}/install cmake --build builddir --target install && rm -rf ${PWD}/install/usr && rmdir ${PWD}/install
      - name: Install
        run: sudo cmake --build builddir --target install
      - name: Test install
        working-directory: example/build_cmake_installed
        run: |
          cmake -B builddir -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}
          cmake --build builddir
          cmake --build builddir --target test
