name: basic-test

on:
  workflow_call:

concurrency:
  group: ${ {github.event_name }}-${{ github.workflow }}-${{ github.ref }}-cibasic
  cancel-in-progress: ${{github.event_name == 'pull_request'}}

permissions: read-all

jobs:
  gcc-smoketest:
    name: gcc-smoketest
    runs-on: [ubuntu-latest]

    steps:
      - name: checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          path: kokkos

      - name: configure kokkos
        working-directory: kokkos
        run: |
          export CMAKE_BUILD_PARALLEL_LEVEL=4
          export ENV_CMAKE_OPTIONS=""
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D CMAKE_BUILD_TYPE=Debug"
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D CMAKE_CXX_COMPILER=clang++"
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D Kokkos_ENABLE_TESTS=ON"
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D CMAKE_CXX_FLAGS='-Werror'"
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D Kokkos_ENABLE_COMPILER_WARNINGS=OFF"
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D Kokkos_ENABLE_DEPRECATED_CODE_4=ON"
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D Kokkos_ENABLE_EXAMPLES=ON"
          export ENV_CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS};-D Kokkos_ENABLE_SERIAL=ON"
          ctest -V \
            -D CMAKE_OPTIONS="${ENV_CMAKE_OPTIONS}" \
            -S CTestRun.cmake \
            -D GITHUB_PR_ID=${{ github.event.number }} \
            -D CTEST_SITE="GitHub" \
            -D CTEST_BUILD_NAME="smoke test"
